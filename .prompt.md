# Comprehensive Django ERP System Development Prompt

You are building a complete Django-based ERP system focused on user authentication, verification, and access management. This system will handle all user-related operations including registration, KYC verification, OTP management, and role-based access control.

## Project Overview

Create a Django application named "accounts" that serves as a comprehensive user management ERP system. This app must use **custom database tables** - do NOT use Django's built-in User model or authentication tables. All models should be created from scratch.

## Core Requirements

### 1. User Management System
- Multi-step registration with verification tracking
- Role-based access control (Super Admin, Admin, User)
- Branch-based user organization
- Complete KYC verification workflow
- Platform and feature-level access control
- Comprehensive audit trails

### 2. Security Features
- OTP-based verification for email and mobile
- Multi-attempt blocking mechanism
- Device and IP tracking
- Session management
- Encrypted storage for sensitive data (Aadhaar, bank account numbers)

## Database Schema Design

### Table 1: UserAccount (Custom User Model)

**Purpose**: Core user information and authentication

**Fields**:
- `id` - BigAutoField (primary key, auto-increment)
- `user_code` - CharField(6) - Unique code mixing A-Z uppercase + 0-9 (e.g., "AAB1T1", "5X9K2L")
- `email` - EmailField (unique, indexed)
- `mobile` - CharField(15) with validation for Indian format (+91)
- `password` - CharField(128) - Hashed password
- `user_role` - CharField choices: ['super_admin', 'admin', 'user']
- `branch_code` - ForeignKey to Branch model
- `first_name` - CharField(50)
- `middle_name` - CharField(50, nullable)
- `last_name` - CharField(50)
- `gender` - CharField choices: ['male', 'female', 'other']
- `dob` - DateField (Date of Birth)

**Verification Flags**:
- `is_mobile_verified` - BooleanField(default=False)
- `is_email_verified` - BooleanField(default=False)
- `is_kyc_complete` - BooleanField(default=False)
- `kyc_verification_step` - IntegerField (0-4: 0=not started, 1=mobile/email, 2=Aadhaar, 3=PAN, 4=Bank)
- `is_aadhaar_verified` - BooleanField(default=False)
- `is_pan_verified` - BooleanField(default=False)
- `is_bank_verified` - BooleanField(default=False)

**Account Status**:
- `is_active` - BooleanField(default=False) - Activated after email/mobile verification
- `is_staff` - BooleanField(default=False)
- `is_superuser` - BooleanField(default=False)
- `user_blocked` - IntegerField(default=0) - Count of times user was blocked
- `user_block_reason` - TextField(nullable) - Latest block reason
- `blocked_until` - DateTimeField(nullable) - Temporary block expiry

**OTP Attempt Tracking**:
- `email_otp_attempts` - IntegerField(default=0)
- `mobile_otp_attempts` - IntegerField(default=0)
- `email_blocked_until` - DateTimeField(nullable)
- `mobile_blocked_until` - DateTimeField(nullable)

**Address Information**:
- `address_line1` - CharField(255)
- `address_line2` - CharField(255, nullable)
- `address_line3` - CharField(255, nullable)
- `city` - CharField(100)
- `state` - CharField(100)
- `country` - CharField(100, default='India')
- `pincode` - CharField(6) with validation

**Security & Audit**:
- `register_device_ip` - GenericIPAddressField
- `register_device_info` - JSONField (user agent, device details)
- `last_login` - DateTimeField(nullable)
- `last_login_ip` - GenericIPAddressField(nullable)
- `password_changed_at` - DateTimeField(nullable)
- `created_at` - DateTimeField(auto_now_add)
- `updated_at` - DateTimeField(auto_now)
- `updated_last_field` - CharField(100, nullable) - Track which field was last modified
- `deleted_at` - DateTimeField(nullable) - Soft delete
- `deleted_by` - ForeignKey(UserAccount, nullable)

**Registration Progress Tracking**:
- `registration_step` - IntegerField(default=0) - Track registration progress
- `registration_data` - JSONField - Store incomplete registration data

**Indexes**: email, mobile, user_code, branch_code, is_active

---

### Table 2: OTPRecord

**Purpose**: Centralized OTP management for all verification types

**Fields**:
- `id` - BigAutoField (primary key)
- `user_code` - ForeignKey to UserAccount
- `otp_type` - CharField choices: ['email', 'mobile', 'both', 'aadhaar', 'bank_phone', 'bank_email', 'business_phone', 'business_email']
- `otp_purpose` - CharField choices: ['registration', 'login', 'forgot_password', 'reset_password', 'email_verification', 'mobile_verification', 'aadhaar_verification', 'bank_verification', 'business_verification']
- `otp_code` - CharField(6) - Encrypted/hashed
- `email_otp` - CharField(6, nullable) - For 'both' type
- `mobile_otp` - CharField(6, nullable) - For 'both' type
- `sent_to_email` - EmailField(nullable)
- `sent_to_mobile` - CharField(15, nullable)
- `is_used` - BooleanField(default=False)
- `verified_at` - DateTimeField(nullable)
- `sent_at` - DateTimeField(auto_now_add)
- `expires_at` - DateTimeField - Calculated (sent_at + 5/10/15 minutes based on type)
- `attempt_count` - IntegerField(default=0)
- `ip_address` - GenericIPAddressField
- `created_at` - DateTimeField(auto_now_add)

**Business Rules**:
- OTP validity: 5 mins for login, 10 mins for registration, 15 mins for KYC
- Max attempts: 3 for email, 5 for mobile
- Automatic cleanup of expired OTPs (cron job)

**Indexes**: user_code, otp_type, otp_purpose, is_used, expires_at

***

### Table 3: Branch

**Purpose**: Organization branch/location management

**Fields**:
- `id` - BigAutoField (primary key)
- `branch_code` - CharField(5) - Unique code (e.g., "AAB14", "XY9ZK")
- `branch_name` - CharField(200)
- `address_line1` - CharField(255)
- `address_line2` - CharField(255, nullable)
- `address_line3` - CharField(255, nullable)
- `city` - CharField(100)
- `state` - CharField(100)
- `country` - CharField(100, default='India')
- `pincode` - CharField(6)
- `phone` - CharField(15, unique)
- `email` - EmailField(unique)
- `manager_name` - CharField(100)
- `manager_user_code` - ForeignKey(UserAccount, nullable, related_name='managed_branches')
- `referred_by` - ForeignKey(Branch, nullable, self-referential) - Parent branch
- `is_active` - BooleanField(default=True)
- `created_at` - DateTimeField(auto_now_add)
- `created_by` - ForeignKey(UserAccount)
- `updated_at` - DateTimeField(auto_now)
- `deleted_at` - DateTimeField(nullable)
- `deleted_by` - ForeignKey(UserAccount, nullable)

**Indexes**: branch_code, is_active, referred_by

***

### Table 4: AppFeature

**Purpose**: Define system features/modules for access control

**Fields**:
- `id` - BigAutoField (primary key)
- `feature_code` - CharField(4) - Unique code (e.g., "PAY1", "RPT2", "USR3")
- `feature_name` - CharField(100)
- `feature_description` - TextField
- `parent_feature` - ForeignKey(AppFeature, nullable, self-referential) - For sub-features
- `feature_category` - CharField(50) - Group related features
- `is_active` - BooleanField(default=True)
- `created_at` - DateTimeField(auto_now_add)
- `created_by` - ForeignKey(UserAccount)
- `updated_at` - DateTimeField(auto_now)
- `deleted_at` - DateTimeField(nullable)
- `deleted_by` - ForeignKey(UserAccount, nullable)

**Indexes**: feature_code, is_active, parent_feature

***

### Table 5: AadhaarKYC

**Purpose**: Aadhaar card verification and storage

**Fields**:
- `id` - CharField(16, primary_key) - Custom short ID generator
- `user_code` - OneToOneField(UserAccount)
- `aadhaar_number_encrypted` - TextField - Encrypted 12-digit number
- `aadhaar_name` - CharField(100) - Name as per Aadhaar
- `aadhaar_dob` - DateField - Date of Birth from Aadhaar
- `aadhaar_gender` - CharField(10)
- `aadhaar_address` - TextField - Complete address from Aadhaar

**Document Storage**:
- `aadhaar_front_image` - FileField(upload_to='kyc/aadhaar/front/')
- `aadhaar_back_image` - FileField(upload_to='kyc/aadhaar/back/')
- `aadhaar_xml_file` - FileField(nullable, upload_to='kyc/aadhaar/xml/') - Offline XML

**OTP Verification** (for Aadhaar e-KYC):
- `aadhaar_otp_request_id` - CharField(50, nullable) - API request ID
- `aadhaar_otp_attempts` - IntegerField(default=0)
- `aadhaar_blocked_until` - DateTimeField(nullable)

**Verification Status**:
- `verification_method` - CharField choices: ['manual', 'api_digilocker', 'api_uidai', 'offline_xml']
- `is_verified` - BooleanField(default=False)
- `verified_at` - DateTimeField(nullable)
- `verified_by` - ForeignKey(UserAccount, nullable) - Admin who verified
- `verification_remarks` - TextField(nullable)
- `api_response` - JSONField(nullable) - Store API response

**Audit**:
- `created_at` - DateTimeField(auto_now_add)
- `updated_at` - DateTimeField(auto_now)
- `submitted_at` - DateTimeField(nullable)

**Indexes**: user_code, is_verified

***

### Table 6: PANKYC

**Purpose**: PAN card verification and storage

**Fields**:
- `id` - CharField(16, primary_key)
- `user_code` - OneToOneField(UserAccount)
- `pan_number` - CharField(10) - Format: ABCDE1234F (encrypted)
- `pan_name` - CharField(100) - Name as per PAN
- `pan_father_name` - CharField(100)
- `pan_dob` - DateField - Must match Aadhaar DOB

**Document Storage**:
- `pan_image` - FileField(upload_to='kyc/pan/')

**Verification Status**:
- `verification_method` - CharField choices: ['manual', 'api_nsdl', 'api_karza']
- `is_verified` - BooleanField(default=False)
- `verified_at` - DateTimeField(nullable)
- `verified_by` - ForeignKey(UserAccount, nullable)
- `verification_remarks` - TextField(nullable)
- `api_response` - JSONField(nullable)
- `name_match_score` - DecimalField(nullable) - Name matching with Aadhaar (0-100)

**Audit**:
- `created_at` - DateTimeField(auto_now_add)
- `updated_at` - DateTimeField(auto_now)
- `submitted_at` - DateTimeField(nullable)

**Indexes**: user_code, is_verified, pan_number

***

### Table 7: BusinessDetails

**Purpose**: Business/shop information for merchant users

**Fields**:
- `id` - CharField(16, primary_key)
- `user_code` - OneToOneField(UserAccount)

**Liveness Verification**:
- `user_selfie` - FileField(upload_to='business/selfies/')
- `selfie_verified` - BooleanField(default=False)

**Business Information**:
- `business_name` - CharField(200)
- `business_type` - CharField(50) - Sole proprietorship, Partnership, Private Ltd, etc.
- `business_registration_number` - CharField(50, nullable) - GST/Shop Act number
- `business_address_line1` - CharField(255)
- `business_address_line2` - CharField(255, nullable)
- `business_address_line3` - CharField(255, nullable)
- `city` - CharField(100)
- `state` - CharField(100)
- `country` - CharField(100, default='India')
- `pincode` - CharField(6)

**Business Contact with OTP**:
- `business_phone` - CharField(15)
- `business_phone_otp_attempts` - IntegerField(default=0)
- `business_phone_blocked_until` - DateTimeField(nullable)
- `is_business_phone_verified` - BooleanField(default=False)
- `business_email` - EmailField
- `business_email_otp_attempts` - IntegerField(default=0)
- `business_email_blocked_until` - DateTimeField(nullable)
- `is_business_email_verified` - BooleanField(default=False)

**Document Storage**:
- `business_proof_image` - FileField(upload_to='business/proofs/') - Shop/GST certificate

**Verification**:
- `is_verified` - BooleanField(default=False)
- `verified_at` - DateTimeField(nullable)
- `verified_by` - ForeignKey(UserAccount, nullable)
- `verification_remarks` - TextField(nullable)

**Audit**:
- `created_at` - DateTimeField(auto_now_add)
- `updated_at` - DateTimeField(auto_now)

**Indexes**: user_code, is_verified

***

### Table 8: BankDetails

**Purpose**: Bank account verification for payment processing

**Fields**:
- `id` - CharField(16, primary_key)
- `user_code` - OneToOneField(UserAccount)

**Bank Account Information**:
- `account_holder_name` - CharField(100) - Must match PAN name
- `account_number_encrypted` - TextField - Encrypted account number
- `account_number_last4` - CharField(4) - Last 4 digits for display
- `ifsc_code` - CharField(11) - Format: ABCD0123456
- `account_type` - CharField choices: ['savings', 'current', 'fixed_deposit', 'recurring_deposit']
- `bank_name` - CharField(100)
- `branch_name` - CharField(100)
- `branch_address` - CharField(255, nullable)

**Document Storage**:
- `bank_proof_image` - FileField(upload_to='bank/proofs/') - Cancelled cheque/passbook

**Verification Methods**:
- `verification_method` - CharField choices: ['penny_drop', 'manual', 'bank_statement']
- `penny_drop_amount` - DecimalField(nullable) - Amount sent for verification
- `penny_drop_reference` - CharField(50, nullable)
- `is_verified` - BooleanField(default=False)
- `verified_at` - DateTimeField(nullable)
- `verified_by` - ForeignKey(UserAccount, nullable)
- `verification_remarks` - TextField(nullable)
- `api_response` - JSONField(nullable)

**Audit**:
- `created_at` - DateTimeField(auto_now_add)
- `updated_at` - DateTimeField(auto_now)

**Indexes**: user_code, is_verified

---

### Table 9: UserPlatformAccess

**Purpose**: Control user access to different platforms

**Fields**:
- `id` - CharField(16, primary_key)
- `user_code` - ForeignKey(UserAccount)
- `platform` - CharField choices: ['web', 'mobile_app', 'admin_panel', 'api', 'pos_terminal']
- `is_allowed` - BooleanField(default=True)
- `access_level` - CharField choices: ['full', 'read_only', 'restricted']
- `allowed_ip_ranges` - JSONField(nullable) - Whitelist IPs for security
- `granted_by` - ForeignKey(UserAccount, nullable)
- `granted_at` - DateTimeField(auto_now_add)
- `revoked_at` - DateTimeField(nullable)
- `revoked_by` - ForeignKey(UserAccount, nullable)
- `revocation_reason` - TextField(nullable)

**Unique Constraint**: (user_code, platform)

**Indexes**: user_code, platform, is_allowed

***

### Table 10: AppAccessControl

**Purpose**: Feature-level access control for users

**Fields**:
- `id` - CharField(16, primary_key)
- `user_code` - ForeignKey(UserAccount)
- `feature` - ForeignKey(AppFeature)
- `is_allowed` - BooleanField(default=False)
- `access_level` - CharField choices: ['full', 'read_only', 'create_only', 'update_only']
- `granted_by` - ForeignKey(UserAccount, nullable)
- `granted_at` - DateTimeField(auto_now_add)
- `expires_at` - DateTimeField(nullable) - Temporary access
- `revoked_at` - DateTimeField(nullable)
- `revoked_by` - ForeignKey(UserAccount, nullable)

**Unique Constraint**: (user_code, feature)

**Indexes**: user_code, feature, is_allowed

***

### Table 11: LoginActivity

**Purpose**: Track all login attempts and sessions

**Fields**:
- `id` - CharField(16, primary_key)
- `user_code` - ForeignKey(UserAccount, nullable) - Null for failed attempts
- `login_identifier` - CharField(255) - Email/mobile used for login attempt
- `ip_address` - GenericIPAddressField
- `user_agent` - TextField
- `device_info` - JSONField - Browser, OS, device type parsed from user agent
- `location_info` - JSONField(nullable) - City, country from IP
- `status` - CharField choices: ['success', 'failed_password', 'failed_blocked', 'failed_inactive', 'failed_not_found']
- `failure_reason` - CharField(255, nullable)
- `session_token` - CharField(255, nullable) - For session tracking
- `login_timestamp` - DateTimeField(auto_now_add)
- `logout_timestamp` - DateTimeField(nullable)
- `session_duration` - DurationField(nullable)
- `is_suspicious` - BooleanField(default=False) - Flagged by security rules
- `risk_score` - IntegerField(default=0) - 0-100 based on various factors

**Indexes**: user_code, login_timestamp, ip_address, status

***

### Table 12: AuditTrail

**Purpose**: Comprehensive audit log for all system operations

**Fields**:
- `id` - CharField(16, primary_key)
- `user_code` - ForeignKey(UserAccount, nullable) - Who performed the action
- `action` - CharField choices: ['create', 'update', 'delete', 'login', 'logout', 'otp_request', 'otp_verify', 'kyc_submit', 'kyc_approve', 'kyc_reject', 'password_change', 'role_change', 'access_grant', 'access_revoke', 'user_block', 'user_unblock']
- `resource_type` - CharField(50) - Model name (e.g., 'UserAccount', 'AadhaarKYC')
- `resource_id` - CharField(50, nullable) - Object ID
- `resource_identifier` - CharField(100, nullable) - Human-readable identifier (email, user_code)
- `description` - TextField - Human-readable action description
- `old_values` - JSONField(nullable) - Before state
- `new_values` - JSONField(nullable) - After state
- `changed_fields` - JSONField(nullable) - List of modified fields
- `ip_address` - GenericIPAddressField(nullable)
- `user_agent` - TextField(nullable)
- `request_method` - CharField(10, nullable) - GET, POST, PUT, DELETE
- `request_path` - CharField(255, nullable) - API endpoint
- `created_at` - DateTimeField(auto_now_add)

**Indexes**: user_code, action, resource_type, resource_id, created_at

***

### Table 13: RegistrationProgress

**Purpose**: Track multi-step registration progress

**Fields**:
- `id` - CharField(16, primary_key)
- `user_code` - ForeignKey(UserAccount)
- `current_step` - IntegerField - 0=started, 1=email/mobile, 2=basic_info, 3=aadhaar, 4=pan, 5=business, 6=bank, 7=completed
- `steps_completed` - JSONField - List of completed step numbers
- `step_data` - JSONField - Store partial data for each step
- `last_completed_step` - IntegerField
- `last_active_at` - DateTimeField(auto_now)
- `started_at` - DateTimeField(auto_now_add)
- `completed_at` - DateTimeField(nullable)
- `abandoned` - BooleanField(default=False)
- `abandoned_at` - DateTimeField(nullable)

**Indexes**: user_code, current_step, last_active_at

***

### Table 14: SecuritySettings

**Purpose**: User-specific security configurations

**Fields**:
- `id` - CharField(16, primary_key)
- `user_code` - OneToOneField(UserAccount)
- `two_factor_enabled` - BooleanField(default=False)
- `two_factor_method` - CharField choices: ['sms', 'email', 'authenticator']
- `login_notification_enabled` - BooleanField(default=True)
- `suspicious_activity_alert` - BooleanField(default=True)
- `allowed_ip_whitelist` - JSONField(nullable)
- `password_expiry_days` - IntegerField(default=90)
- `last_password_change` - DateTimeField(nullable)
- `failed_login_attempts` - IntegerField(default=0)
- `account_locked_until` - DateTimeField(nullable)
- `created_at` - DateTimeField(auto_now_add)
- `updated_at` - DateTimeField(auto_now)

**Indexes**: user_code

***

## API Endpoints Structure

### Authentication Module

#### Registration APIs
1. **POST /api/v1/auth/register/initiate**
   - Request: `{email, mobile, password}`
   - Response: `{user_code, otp_sent_to, registration_step}`
   - Action: Create user, send OTPs, track in RegistrationProgress

2. **POST /api/v1/auth/register/verify-otp**
   - Request: `{user_code, email_otp, mobile_otp}`
   - Response: `{verified, next_step}`
   - Action: Verify OTPs, update is_email_verified, is_mobile_verified

3. **POST /api/v1/auth/register/basic-info**
   - Request: `{user_code, first_name, last_name, gender, dob, address}`
   - Response: `{saved, next_step}`
   - Action: Save basic information, move to KYC

4. **POST /api/v1/auth/register/resend-otp**
   - Request: `{user_code, otp_type: 'email'|'mobile'}`
   - Response: `{otp_sent, retry_after}`
   - Action: Generate and send new OTP

#### Login APIs
5. **POST /api/v1/auth/login**
   - Request: `{email_or_mobile, password, device_info}`
   - Response: `{token, user_data, requires_2fa}`
   - Action: Authenticate, create session, log in LoginActivity

6. **POST /api/v1/auth/login/verify-2fa**
   - Request: `{user_code, otp_code}`
   - Response: `{token, user_data}`
   - Action: Verify 2FA OTP, complete login

7. **POST /api/v1/auth/logout**
   - Request: `{token}`
   - Response: `{logged_out}`
   - Action: Invalidate session, update logout_timestamp

#### Password Management APIs
8. **POST /api/v1/auth/forgot-password**
   - Request: `{email_or_mobile}`
   - Response: `{otp_sent, reset_token}`
   - Action: Send OTP to both email and mobile

9. **POST /api/v1/auth/verify-reset-otp**
   - Request: `{reset_token, otp_code}`
   - Response: `{verified, password_reset_token}`
   - Action: Verify OTP, generate password reset token

10. **POST /api/v1/auth/reset-password**
    - Request: `{password_reset_token, new_password}`
    - Response: `{password_changed}`
    - Action: Update password, invalidate all sessions

11. **POST /api/v1/auth/change-password**
    - Request: `{old_password, new_password}`
    - Response: `{password_changed}`
    - Requires: Authentication
    - Action: Verify old password, update to new

### KYC Module

#### Aadhaar Verification APIs
12. **POST /api/v1/kyc/aadhaar/submit**
    - Request: `{user_code, aadhaar_number, aadhaar_name, front_image, back_image}`
    - Response: `{submitted, otp_required, request_id}`
    - Action: Save Aadhaar data, trigger e-KYC OTP if API enabled

13. **POST /api/v1/kyc/aadhaar/verify-otp**
    - Request: `{user_code, otp_code, request_id}`
    - Response: `{verified, aadhaar_data}`
    - Action: Verify with UIDAI API, update is_aadhaar_verified

14. **POST /api/v1/kyc/aadhaar/upload-offline**
    - Request: `{user_code, xml_file, share_code}`
    - Response: `{verified, aadhaar_data}`
    - Action: Parse offline Aadhaar XML, auto-verify

#### PAN Verification APIs
15. **POST /api/v1/kyc/pan/submit**
    - Request: `{user_code, pan_number, pan_name, dob, pan_image}`
    - Response: `{submitted, verification_status}`
    - Action: Validate PAN format, verify with NSDL API if enabled

16. **GET /api/v1/kyc/pan/verify-status/{user_code}**
    - Response: `{verified, match_score, remarks}`
    - Action: Check PAN verification status

#### Business Verification APIs
17. **POST /api/v1/kyc/business/submit**
    - Request: `{user_code, business_name, business_type, address, phone, email, selfie, proof}`
    - Response: `{submitted, otp_sent}`
    - Action: Save business details, send OTP to business phone/email

18. **POST /api/v1/kyc/business/verify-contact**
    - Request: `{user_code, contact_type: 'phone'|'email', otp_code}`
    - Response: `{verified}`
    - Action: Verify business contact OTP

#### Bank Verification APIs
19. **POST /api/v1/kyc/bank/submit**
    - Request: `{user_code, account_holder_name, account_number, ifsc_code, account_type, bank_proof}`
    - Response: `{submitted, penny_drop_initiated}`
    - Action: Validate bank details, initiate penny drop if enabled

20. **POST /api/v1/kyc/bank/verify-penny-drop**
    - Request: `{user_code, reference_number, amount}`
    - Response: `{verified}`
    - Action: Verify penny drop amount, update is_bank_verified

#### KYC Status APIs
21. **GET /api/v1/kyc/status/{user_code}**
    - Response: `{overall_status, aadhaar_status, pan_status, business_status, bank_status, current_step}`
    - Action: Return complete KYC verification status

22. **GET /api/v1/kyc/resume/{user_code}**
    - Response: `{last_step, pending_verifications, next_action}`
    - Action: Help user resume incomplete KYC

### User Management Module

#### User Profile APIs
23. **GET /api/v1/users/{user_code}**
    - Response: `{user_data, kyc_status, access_permissions}`
    - Requires: Authentication
    - Action: Fetch complete user profile

24. **PUT /api/v1/users/{user_code}**
    - Request: `{fields_to_update}`
    - Response: `{updated_fields}`
    - Requires: Authentication
    - Action: Update user information (limited fields)

25. **GET /api/v1/users/search**
    - Query: `?email=&mobile=&user_code=&branch_code=`
    - Response: `{users: []}`
    - Requires: Admin authentication
    - Action: Search users with filters

#### Role & Access Management APIs
26. **POST /api/v1/users/{user_code}/assign-role**
    - Request: `{role: 'super_admin'|'admin'|'user'}`
    - Response: `{role_assigned}`
    - Requires: Super admin authentication
    - Action: Update user_role, log in AuditTrail

27. **POST /api/v1/users/{user_code}/platform-access**
    - Request: `{platform, is_allowed, access_level}`
    - Response: `{access_granted}`
    - Requires: Admin authentication
    - Action: Create/update UserPlatformAccess

28. **POST /api/v1/users/{user_code}/feature-access**
    - Request: `{feature_code, is_allowed, access_level, expires_at}`
    - Response: `{access_granted}`
    - Requires: Admin authentication
    - Action: Create/update AppAccessControl

29. **GET /api/v1/users/{user_code}/permissions**
    - Response: `{platform_access: [], feature_access: []}`
    - Requires: Authentication
    - Action: Fetch all user permissions

#### User Blocking APIs
30. **POST /api/v1/users/{user_code}/block**
    - Request: `{reason, block_duration_minutes}`
    - Response: `{blocked_until}`
    - Requires: Admin authentication
    - Action: Set user_blocked, user_block_reason, blocked_until

31. **POST /api/v1/users/{user_code}/unblock**
    - Request: `{reason}`
    - Response: `{unblocked}`
    - Requires: Admin authentication
    - Action: Clear blocking fields, log in AuditTrail

### Branch Management Module

32. **POST /api/v1/branches/**
    - Request: `{branch_name, address, phone, email, manager_user_code, referred_by}`
    - Response: `{branch_code, created}`
    - Requires: Admin authentication
    - Action: Create new branch with auto-generated branch_code

33. **GET /api/v1/branches/**
    - Query: `?is_active=true&search=&limit=20&offset=0`
    - Response: `{branches: [], total_count}`
    - Action: List all branches with pagination

34. **GET /api/v1/branches/{branch_code}**
    - Response: `{branch_data, users_count, sub_branches}`
    - Action: Fetch branch details with statistics

35. **PUT /api/v1/branches/{branch_code}**
    - Request: `{fields_to_update}`
    - Response: `{updated}`
    - Requires: Admin authentication
    - Action: Update branch information

36. **DELETE /api/v1/branches/{branch_code}**
    - Response: `{soft_deleted}`
    - Requires: Super admin authentication
    - Action: Soft delete branch (set deleted_at)

### Feature Management Module

37. **POST /api/v1/features/**
    - Request: `{feature_name, feature_description, parent_feature, feature_category}`
    - Response: `{feature_code, created}`
    - Requires: Super admin authentication
    - Action: Create app feature with auto-generated feature_code

38. **GET /api/v1/features/**
    - Query: `?is_active=true&category=`
    - Response: `{features: []}`
    - Action: List all features

39. **PUT /api/v1/features/{feature_code}**
    - Request: `{fields_to_update}`
    - Response: `{updated}`
    - Requires: Super admin authentication
    - Action: Update feature details

### Audit & Reporting Module

40. **GET /api/v1/audit/user/{user_code}**
    - Query: `?action=&from_date=&to_date=&limit=50`
    - Response: `{audit_logs: [], total_count}`
    - Requires: Admin authentication
    - Action: Fetch user's audit trail

41. **GET /api/v1/audit/system**
    - Query: `?action=&resource_type=&from_date=&to_date=&limit=100`
    - Response: `{audit_logs: [], total_count}`
    - Requires: Super admin authentication
    - Action: Fetch system-wide audit logs

42. **GET /api/v1/reports/login-activity**
    - Query: `?user_code=&from_date=&to_date=&status=`
    - Response: `{login_activities: [], suspicious_count}`
    - Requires: Admin authentication
    - Action: Generate login activity report

43. **GET /api/v1/reports/kyc-status**
    - Query: `?branch_code=&verification_step=`
    - Response: `{kyc_stats: {pending, in_progress, completed, rejected}}`
    - Requires: Admin authentication
    - Action: KYC verification statistics

44. **GET /api/v1/reports/registration-funnel**
    - Query: `?from_date=&to_date=`
    - Response: `{funnel_data: {step_0, step_1, ...}, drop_off_rates}`
    - Requires: Admin authentication
    - Action: Registration completion funnel analysis

### OTP Management Module

45. **GET /api/v1/otp/history/{user_code}**
    - Query: `?otp_type=&otp_purpose=&limit=20`
    - Response: `{otp_history: []}`
    - Requires: Admin authentication
    - Action: Fetch OTP send/verify history for debugging

### Security Module

46. **POST /api/v1/security/settings/{user_code}**
    - Request: `{two_factor_enabled, login_notification_enabled, allowed_ip_whitelist}`
    - Response: `{settings_updated}`
    - Requires: Authentication (own settings only)
    - Action: Update user security preferences

47. **GET /api/v1/security/suspicious-activity/{user_code}**
    - Response: `{suspicious_logins: [], flagged_activities: []}`
    - Requires: Authentication
    - Action: Show suspicious activity alerts

## Implementation Guidelines

### Code Structure
```
accounts/
├── __init__.py
├── models.py (all 14 tables)
├── serializers.py (DRF serializers)
├── views.py (API views)
├── urls.py (URL routing)
├── utils/
│   ├── otp_generator.py
│   ├── code_generator.py (user_code, branch_code, feature_code)
│   ├── encryption.py (for sensitive data)
│   ├── validators.py (PAN, Aadhaar, IFSC validation)
│   └── security.py (blocking logic, risk scoring)
├── services/
│   ├── otp_service.py (send via SMS/email providers)
│   ├── kyc_service.py (API integrations)
│   ├── audit_service.py (logging)
│   └── notification_service.py
├── middleware/
│   ├── authentication.py (custom auth)
│   └── audit_middleware.py (auto-logging)
├── tasks.py (Celery tasks for OTP cleanup, notifications)
├── permissions.py (custom DRF permissions)
├── admin.py (Django admin customization)
└── tests/
    ├── test_models.py
    ├── test_apis.py
    └── test_services.py
```

### Security Best Practices
1. **Password Hashing**: Use Django's `make_password()` and `check_password()`
2. **Sensitive Data Encryption**: Encrypt Aadhaar and bank account numbers using `cryptography` library
3. **OTP Security**: Hash OTPs before storage, implement rate limiting
4. **Token Management**: Use JWT with short expiry (15 mins access, 7 days refresh)
5. **IP Whitelisting**: Enforce for admin/API access
6. **Audit Everything**: Log all CRUD operations, login attempts, permission changes
7. **Input Validation**: Strict validation for PAN, Aadhaar, IFSC, mobile formats
8. **SQL Injection Prevention**: Use Django ORM (never raw SQL with user input)
9. **CORS Configuration**: Whitelist allowed origins
10. **Rate Limiting**: Implement per-IP and per-user rate limits

### Performance Optimization
1. **Database Indexing**: Add indexes on frequently queried fields (email, mobile, user_code)
2. **Query Optimization**: Use `select_related()` and `prefetch_related()` to avoid N+1 queries
3. **Caching**: Cache user permissions, branch data using Redis
4. **Pagination**: Always paginate list endpoints (default 20 items)
5. **Async Tasks**: Use Celery for OTP sending, email notifications, API calls
6. **File Storage**: Use S3/cloud storage for KYC documents, not local filesystem

### Validation Rules
1. **User Code**: 6 characters, uppercase A-Z + 0-9, unique
2. **Branch Code**: 5 characters, uppercase A-Z + 0-9, unique
3. **Feature Code**: 4 characters, uppercase A-Z + 0-9, unique
4. **Mobile**: Indian format validation (+91, 10 digits)
5. **Email**: Standard email format with domain validation
6. **PAN**: ABCDE1234F format (5 letters, 4 numbers, 1 letter)
7. **Aadhaar**: 12 digits (validate with Verhoeff algorithm)
8. **IFSC**: ABCD0123456 format (4 letters, 0, 6 alphanumeric)
9. **Pincode**: 6 digits, validate against Indian pincode database

### OTP Configuration
| Purpose | Channel | Validity | Max Attempts | Cooldown |
|---------|---------|----------|--------------|----------|
| Registration | Email + Mobile | 10 mins | 3 | 60 seconds |
| Login | Both | 5 mins | 5 | 30 seconds |
| Password Reset | Both | 15 mins | 3 | 120 seconds |
| Aadhaar Verification | Mobile | 10 mins | 3 | 60 seconds |
| Business Contact | Email/Mobile | 10 mins | 3 | 60 seconds |

### KYC Verification Workflow
1. **Step 0**: User registration (email + mobile verification)
2. **Step 1**: Basic information (name, DOB, address)
3. **Step 2**: Aadhaar verification (upload + OTP or offline XML)
4. **Step 3**: PAN verification (auto-verify with API or manual)
5. **Step 4**: Business details (if merchant user)
6. **Step 5**: Bank account verification (penny drop or manual)
7. **Step 6**: Admin approval (optional for high-risk users)

### Testing Requirements
1. Unit tests for all models (field validations, methods)
2. API tests for all 47 endpoints (success + error scenarios)
3. Integration tests for KYC workflow (multi-step process)
4. Security tests (authentication, authorization, injection attempts)
5. Performance tests (load testing on login, OTP APIs)
6. Test coverage: Minimum 80%

### Documentation Requirements
1. **API Documentation**: Use Swagger/OpenAPI with request/response examples
2. **Database Schema**: ER diagram with relationships
3. **Deployment Guide**: Environment setup, database migrations
4. **User Manual**: Step-by-step KYC completion guide
5. **Admin Guide**: User management, role assignment procedures

## Deliverables

Please provide:
1. Complete Django models code for all 14 tables
2. DRF serializers for all models
3. All 47 API endpoints with complete implementation
4. Utility functions (code generators, validators, encryption)
5. Service layer implementations (OTP, KYC, audit)
6. Custom middleware for authentication and audit logging
7. Celery tasks for async operations
8. Unit tests for critical functionality
9. Swagger documentation
10. Database migration files
11. requirements.txt with all dependencies
12. README with setup instructions

## Technology Stack
- **Backend**: Django 4.2+ with Django REST Framework
- **Database**: PostgreSQL 14+
- **Cache**: Redis 7+
- **Task Queue**: Celery with Redis broker
- **Storage**: AWS S3 or compatible for file uploads
- **Authentication**: JWT (djangorestframework-simplejwt)
- **Documentation**: drf-yasg for Swagger
- **Encryption**: cryptography library
- **Validation**: django-phonenumber-field, custom validators

Begin implementation with the UserAccount model and authentication APIs, then progressively add KYC, access control, and audit features. Ensure each component is tested before moving to the next.